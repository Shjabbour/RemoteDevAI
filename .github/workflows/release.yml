name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: |
            # RemoteDevAI v${{ steps.version.outputs.version }}

            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Docker Images

            - Cloud: `docker pull remotedevai/cloud:${{ steps.version.outputs.version }}`
            - Desktop: `docker pull remotedevai/desktop:${{ steps.version.outputs.version }}`

            ## Installation

            See the [Installation Guide](https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION.md) for detailed instructions.

            ## Full Changelog

            **Full Changelog**: https://github.com/${{ github.repository }}/commits/v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false

  build-cli:
    name: Build CLI Binaries
    runs-on: ${{ matrix.os }}
    needs: create-release
    if: contains(github.repository, 'RemoteDevAI')

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            artifact: remotedevai-cli-linux-x64
          - os: macos-latest
            target: darwin-x64
            artifact: remotedevai-cli-darwin-x64
          - os: macos-latest
            target: darwin-arm64
            artifact: remotedevai-cli-darwin-arm64
          - os: windows-latest
            target: win-x64
            artifact: remotedevai-cli-win-x64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CLI
        run: |
          npm run build -w @remotedevai/cli
          cd packages/cli
          npm run package -- --target ${{ matrix.target }}

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./packages/cli/dist/${{ matrix.artifact }}
          asset_name: ${{ matrix.artifact }}
          asset_content_type: application/octet-stream

  build-desktop-installers:
    name: Build Desktop Installers
    runs-on: ${{ matrix.os }}
    needs: create-release

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: darwin
          - os: windows-latest
            platform: win32

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Desktop App
        run: npm run build -w @remotedevai/desktop

      - name: Package Desktop App
        run: |
          cd packages/desktop
          npm run package

      - name: Upload installers
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./packages/desktop/dist/remotedevai-${{ matrix.platform }}-installer
          asset_name: remotedevai-${{ matrix.platform }}-installer
          asset_content_type: application/octet-stream

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: create-release
    if: contains(github.repository, 'RemoteDevAI')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Publish @remotedevai/shared
        run: npm publish --workspace @remotedevai/shared
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @remotedevai/cli
        run: npm publish --workspace @remotedevai/cli
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: [create-release, publish-npm]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update version in docs
        run: |
          VERSION=${{ needs.create-release.outputs.version }}
          find docs -type f -name "*.md" -exec sed -i "s/version: .*/version: $VERSION/g" {} +

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "docs: update version to ${{ needs.create-release.outputs.version }}"
          title: "Update documentation for v${{ needs.create-release.outputs.version }}"
          body: |
            Automated documentation update for release v${{ needs.create-release.outputs.version }}
          branch: docs/update-v${{ needs.create-release.outputs.version }}
          delete-branch: true

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, build-cli, build-desktop-installers, publish-npm]
    if: always()

    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            New release published!
            Version: v${{ needs.create-release.outputs.version }}
            Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.create-release.outputs.version }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Send Discord notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "RemoteDevAI v${{ needs.create-release.outputs.version }} Released!"
          description: |
            A new version of RemoteDevAI has been released!
            [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.create-release.outputs.version }})
          color: 0x00ff00
